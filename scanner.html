<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø±Ø¦ QR Code - ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Instascan (Ù…ÙƒØªØ¨Ø© Ø®ÙÙŠÙØ© ÙˆØ³Ø±ÙŠØ¹Ø© Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§) -->
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a35 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .navbar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            transform: rotate(10deg);
            position: relative;
        }

        .logo-icon::before {
            content: 'ğŸ“…';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            font-size: 20px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 800;
            color: #fff;
            text-decoration: none;
        }

        .logo-text span {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 28px;
        }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .scanner-wrapper {
            max-width: 1200px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }

        /* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© */
        .page-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea, #764ba2, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-title p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .camera-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ØªØ±Ø§ÙƒØ¨ Ø§Ù„Ù…Ø³Ø­ */
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        .scan-frame::before,
        .scan-frame::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #667eea;
            border-style: solid;
        }

        .scan-frame::before {
            top: -3px;
            left: -3px;
            border-width: 3px 0 0 3px;
            border-radius: 15px 0 0 0;
        }

        .scan-frame::after {
            bottom: -3px;
            right: -3px;
            border-width: 0 3px 3px 0;
            border-radius: 0 0 15px 0;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #667eea, #764ba2, transparent);
            animation: scan 2s linear infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.8; }
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 15px 40px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
        }

        .control-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .camera-status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            display: inline-block;
            width: auto;
            margin: 0 auto 20px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        .status-dot.active {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-dot.inactive {
            background: #ef4444;
        }

        .status-dot.waiting {
            background: #f59e0b;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª */
        .camera-selector {
            text-align: center;
            margin: 20px 0;
        }

        .camera-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 12px 30px;
            color: #fff;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            outline: none;
            min-width: 250px;
        }

        .camera-select option {
            background: #1a1a2f;
            color: #fff;
        }

        /* Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ */
        .result-section {
            margin-top: 30px;
            display: none;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 30px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .result-icon.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .result-icon.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .result-icon.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .result-title {
            font-size: 24px;
            font-weight: 700;
        }

        .guest-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-right: 4px solid #10b981;
        }

        .toast.error {
            border-right: 4px solid #ef4444;
        }

        /* ØªØ¹Ù„ÙŠÙ…Ø§Øª */
        .instructions {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .instruction-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .instruction-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: #667eea;
            font-size: 20px;
        }

        .instruction-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-5px);
        }

        /* ØªØ°ÙŠÙŠÙ„ */
        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 50px;
        }

        @media (max-width: 768px) {
            .page-title h1 {
                font-size: 2rem;
            }
            
            .camera-card {
                padding: 20px;
            }
            
            .scan-frame {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">
                    <span>E</span>vent
                </div>
            </a>
        </div>
    </nav>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="scanner-wrapper">
        <!-- Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹ÙˆØ¯Ø© -->
        <a href="#" class="back-link" onclick="goBack()">
            <i class="fas fa-arrow-right"></i>
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>

        <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
        <div class="page-title">
            <h1>
                Ù‚Ø§Ø±Ø¦ <span class="gradient-text">QR Code</span>
            </h1>
            <p>ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø±Ù…Ø² QR Ù„Ù…Ø³Ø­Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        </div>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="camera-card">
            <!-- Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
            <div class="camera-status" id="cameraStatus">
                <div class="status-indicator">
                    <span class="status-dot waiting" id="statusDot"></span>
                    <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</span>
                </div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© -->
            <div class="camera-selector" id="cameraSelector" style="display: none;">
                <select class="camera-select" id="cameraSelect" onchange="switchCamera(this.value)">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</option>
                </select>
            </div>

            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
            <div class="camera-container">
                <video id="preview"></video>
                <div class="scan-overlay">
                    <div class="scan-frame">
                        <div class="scan-line"></div>
                    </div>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="camera-controls">
                <button class="control-btn primary" onclick="startCamera()" id="startBtn">
                    <i class="fas fa-play"></i>
                    ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button class="control-btn" onclick="stopCamera()" id="stopBtn" disabled>
                    <i class="fas fa-stop"></i>
                    Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button class="control-btn" onclick="testCamera()" id="testBtn">
                    <i class="fas fa-video"></i>
                    Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button class="control-btn danger" onclick="resetScanner()" id="resetBtn">
                    <i class="fas fa-redo-alt"></i>
                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„
                </button>
            </div>

            <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø­ -->
            <div class="instructions">
                <div class="instruction-item">
                    <div class="instruction-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div class="instruction-text">ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ QR</div>
                </div>
                <div class="instruction-item">
                    <div class="instruction-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="instruction-text">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
                </div>
                <div class="instruction-item">
                    <div class="instruction-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="instruction-text">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‡Ù†Ø§</div>
                </div>
            </div>
        </div>

        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ -->
        <div class="result-section" id="resultSection">
            <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¶Ø§Ù Ù‡Ù†Ø§ -->
        </div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ -->
    <div class="footer">
        <p>Â© 2024 EVENT - Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ø¹ QR Code</p>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let scanner = null;
        let currentCamera = null;
        let isScanning = false;
        let cameras = [];

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            checkCameraSupport();
            requestCameraPermission();
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
                updateStatus('ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'inactive');
                return false;
            }
            return true;
        }

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function requestCameraPermission() {
            try {
                updateStatus('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†...', 'waiting');
                
                // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
                stream.getTracks().forEach(track => track.stop());
                
                showToast('ØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'success');
                updateStatus('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©', 'active');
                
                // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
                document.getElementById('startBtn').disabled = false;
                document.getElementById('testBtn').disabled = false;
                
                // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
                await getCameras();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†:', error);
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
                updateStatus('ØºÙŠØ± Ù…ØµØ±Ø­', 'inactive');
            }
        }

        // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(device => device.kind === 'videoinput');
                
                if (cameras.length > 0) {
                    const selector = document.getElementById('cameraSelector');
                    const select = document.getElementById('cameraSelect');
                    
                    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</option>';
                    
                    cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.text = camera.label || `ÙƒØ§Ù…ÙŠØ±Ø§ ${index + 1}`;
                        select.appendChild(option);
                    });
                    
                    selector.style.display = 'block';
                    
                    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
                    const backCamera = cameras.find(c => 
                        c.label.toLowerCase().includes('back') || 
                        c.label.toLowerCase().includes('rear') ||
                        c.label.toLowerCase().includes('Ø®Ù„ÙÙŠØ©')
                    );
                    
                    if (backCamera) {
                        select.value = backCamera.deviceId;
                        currentCamera = backCamera.deviceId;
                    } else if (cameras.length > 0) {
                        select.value = cameras[0].deviceId;
                        currentCamera = cameras[0].deviceId;
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª:', error);
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCamera() {
            if (!checkCameraSupport()) return;

            try {
                updateStatus('Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...', 'waiting');
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙƒØ§Ù…ÙŠØ±Ø§ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„
                stopCamera();

                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                const constraints = {
                    video: {
                        deviceId: currentCamera ? { exact: currentCamera } : undefined,
                        facingMode: currentCamera ? undefined : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('preview');
                video.srcObject = stream;
                video.play();

                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­
                initializeScanner(video);

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                updateStatus('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„', 'active');
                showToast('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
                showToast('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message, 'error');
                updateStatus('ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„', 'inactive');
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­
        function initializeScanner(video) {
            if (scanner) {
                scanner.stop();
            }

            scanner = new Instascan.Scanner({
                video: video,
                mirror: false,
                scanPeriod: 1,
                refractoryPeriod: 1000
            });

            scanner.addListener('scan', function(content) {
                handleScanResult(content);
            });

            isScanning = true;
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function stopCamera() {
            const video = document.getElementById('preview');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            if (scanner) {
                scanner.stop();
                scanner = null;
            }
            
            isScanning = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙˆÙ‚ÙØ©', 'inactive');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function testCamera() {
            try {
                showToast('Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...', 'info');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø«Ù… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    showToast('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø§Ø¬Ø­ âœ“', 'success');
                }, 2000);
                
            } catch (error) {
                showToast('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
            }
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function switchCamera(deviceId) {
            if (!deviceId) return;
            currentCamera = deviceId;
            
            if (isScanning) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                stopCamera();
                setTimeout(() => {
                    startCamera();
                }, 500);
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­
        function handleScanResult(content) {
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            if (scanner) {
                scanner.stop();
            }

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ JSON
                const data = JSON.parse(content);
                
                // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ù…Ù†Ø³Ù‚Ø©
                showResult({
                    type: 'success',
                    title: 'ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­',
                    data: data
                });
                
                showToast(`ØªÙ… Ù…Ø³Ø­ QR: ${data.guest || 'Ù…Ø¯Ø¹Ùˆ'}`, 'success');
                
            } catch (e) {
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                showResult({
                    type: 'info',
                    title: 'Ù†Øµ QR Code',
                    data: { content: content }
                });
                
                showToast('ØªÙ… Ù…Ø³Ø­ QR Ø¨Ù†Ø¬Ø§Ø­', 'info');
            }
        }

        // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­
        function showResult(result) {
            const section = document.getElementById('resultSection');
            
            let content = '';
            
            if (result.data.guest) {
                // Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ø¹Ùˆ
                content = `
                    <div class="guest-info">
                        <div class="info-item">
                            <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø¹Ùˆ</div>
                            <div class="info-value">${result.data.guest}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</div>
                            <div class="info-value">${result.data.event || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø¹Ø¯</div>
                            <div class="info-value">${result.data.seat || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-success" onclick="confirmAttendance()">
                            <i class="fas fa-check"></i>
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±
                        </button>
                        <button class="action-btn btn-primary" onclick="resumeScanning()">
                            <i class="fas fa-redo-alt"></i>
                            Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                `;
            } else {
                // Ù†Øµ Ø¹Ø§Ø¯ÙŠ
                content = `
                    <div class="result-content" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 20px 0; word-break: break-all;">
                        ${result.data.content || JSON.stringify(result.data, null, 2)}
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-primary" onclick="copyToClipboard('${result.data.content || JSON.stringify(result.data)}')">
                            <i class="fas fa-copy"></i>
                            Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                        </button>
                        <button class="action-btn btn-primary" onclick="resumeScanning()">
                            <i class="fas fa-redo-alt"></i>
                            Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                `;
            }

            section.innerHTML = `
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-icon ${result.type}">
                            <i class="fas fa-${result.type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        </div>
                        <div class="result-title">
                            ${result.title}
                        </div>
                    </div>
                    ${content}
                </div>
            `;
            
            section.style.display = 'block';
        }

        // Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù…Ø³Ø­
        function resumeScanning() {
            document.getElementById('resultSection').style.display = 'none';
            if (scanner && !isScanning) {
                scanner.start();
                isScanning = true;
            }
        }

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±
        function confirmAttendance() {
            showToast('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
            setTimeout(() => {
                resumeScanning();
            }, 1500);
        }

        // Ù†Ø³Ø® Ø§Ù„Ù†Øµ
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
            }).catch(() => {
                showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'error');
            });
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­
        function resetScanner() {
            stopCamera();
            document.getElementById('resultSection').style.display = 'none';
            updateStatus('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„', 'waiting');
            showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…', 'info');
            
            setTimeout(() => {
                startCamera();
            }, 1000);
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function updateStatus(text, type) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot ' + type;
        }

        // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            else if (type === 'error') icon = 'times-circle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function goBack() {
            stopCamera();
            window.location.href = 'index.html';
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function() {
            stopCamera();
        });

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        setTimeout(() => {
            startCamera();
        }, 1000);
    </script>

    <style>
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</body>
</html>